<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lazy Loading Background Images</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }

        .carousel-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }

        .card-image {
            height: 250px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: transform 0.5s ease-in-out, opacity 0.3s ease;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .card-image:hover {
            transform: scale(1.05);
        }

        /* Lazy loading states */
        .card-image.lazy {
            background-image: none !important;
            opacity: 0;
        }

        .card-image.lazy-loaded {
            opacity: 1;
        }

        .card-image.lazy-error {
            background-color: #ffe6e6;
            opacity: 1;
        }

        /* Loading placeholder */
        .loading-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 14px;
            border-radius: 8px;
        }

        .loading-placeholder.hidden {
            display: none;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Error state */
        .error-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f8f8f8;
            display: none;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            border-radius: 8px;
            border: 2px dashed #ddd;
        }

        .error-placeholder.show {
            display: flex;
        }

        /* Card content overlay */
        .card-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            color: white;
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .card-image:hover .card-content {
            transform: translateY(0);
        }

        .card-title {
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: bold;
        }

        .card-description {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        /* Performance info section */
        .info-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px auto;
            max-width: 1200px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .technique-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .technique-item {
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            border-radius: 4px;
        }

        .technique-item h4 {
            margin: 0 0 8px 0;
            color: #333;
        }

        .technique-item p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat {
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 4px;
            flex: 1;
            min-width: 120px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="info-section">
        <h2>Lazy Loading Background Images Demo</h2>
        <p>Scroll down to see the lazy loading in action. Images load only when they come into view.</p>
        
        <div class="stats">
            <div class="stat">
                <span class="stat-value" id="loaded-count">0</span>
                <div class="stat-label">Images Loaded</div>
            </div>
            <div class="stat">
                <span class="stat-value" id="total-count">6</span>
                <div class="stat-label">Total Images</div>
            </div>
            <div class="stat">
                <span class="stat-value" id="data-saved">0</span>
                <div class="stat-label">KB Saved</div>
            </div>
        </div>
    </div>

    <div class="carousel-container">
        <!-- Card 1 -->
        <div class="card-image w-100 lazy" 
             data-bg="https://staging3.511tactical.com/media/wysiwyg/expand/bagsAndPacks.png"
             data-size="150">
            <div class="loading-placeholder">Loading bags & packs...</div>
            <div class="error-placeholder">Failed to load image</div>
            <div class="card-content">
                <h3 class="card-title">Bags & Packs</h3>
                <p class="card-description">Tactical bags and backpacks for every mission</p>
            </div>
        </div>

        <!-- Card 2 -->
        <div class="card-image w-100 lazy" 
             data-bg="https://staging3.511tactical.com/media/wysiwyg/expand/hero-with-time-stamp-desktop.png"
             data-size="200">
            <div class="error-placeholder">Failed to load image</div>
            <div class="card-content">
                <h3 class="card-title">Hero Banner</h3>
                <p class="card-description">Featured promotional content</p>
            </div>
        </div>

        <!-- Card 3 - Demo with placeholder -->
        <div class="card-image w-100 lazy" 
             data-bg="https://picsum.photos/400/300?random=1"
             data-size="120">
            <div class="loading-placeholder">Loading gear...</div>
            <div class="error-placeholder">Failed to load image</div>
            <div class="card-content">
                <h3 class="card-title">Tactical Gear</h3>
                <p class="card-description">Professional equipment and accessories</p>
            </div>
        </div>

        <!-- Card 4 -->
        <div class="card-image w-100 lazy" 
             data-bg="https://picsum.photos/400/300?random=2"
             data-size="130">
            <div class="loading-placeholder">Loading apparel...</div>
            <div class="error-placeholder">Failed to load image</div>
            <div class="card-content">
                <h3 class="card-title">Apparel</h3>
                <p class="card-description">High-performance tactical clothing</p>
            </div>
        </div>

        <!-- Card 5 -->
        <div class="card-image w-100 lazy" 
             data-bg="https://picsum.photos/400/300?random=3"
             data-size="140">
            <div class="loading-placeholder">Loading footwear...</div>
            <div class="error-placeholder">Failed to load image</div>
            <div class="card-content">
                <h3 class="card-title">Footwear</h3>
                <p class="card-description">Durable boots and tactical shoes</p>
            </div>
        </div>

        <!-- Card 6 -->
        <div class="card-image w-100 lazy" 
             data-bg="https://picsum.photos/400/300?random=4"
             data-size="160">
            <div class="loading-placeholder">Loading accessories...</div>
            <div class="error-placeholder">Failed to load image</div>
            <div class="card-content">
                <h3 class="card-title">Accessories</h3>
                <p class="card-description">Essential tactical accessories</p>
            </div>
        </div>
    </div>

    <div class="info-section">
        <h3>Implementation Features</h3>
        <div class="technique-grid">
            <div class="technique-item">
                <h4>Intersection Observer</h4>
                <p>Modern API for efficient viewport detection with configurable thresholds</p>
            </div>
            <div class="technique-item">
                <h4>Progressive Loading</h4>
                <p>Images load with smooth opacity transitions and loading states</p>
            </div>
            <div class="technique-item">
                <h4>Error Handling</h4>
                <p>Graceful fallbacks when images fail to load</p>
            </div>
            <div class="technique-item">
                <h4>Performance Metrics</h4>
                <p>Real-time tracking of loaded images and data savings</p>
            </div>
            <div class="technique-item">
                <h4>Memory Efficient</h4>
                <p>Automatically unobserves loaded images to free memory</p>
            </div>
            <div class="technique-item">
                <h4>Responsive Design</h4>
                <p>Maintains aspect ratios and works across all screen sizes</p>
            </div>
        </div>
    </div>

    <script>
        class LazyBackgroundLoader {
            constructor(options = {}) {
                this.options = {
                    rootMargin: '50px 0px',
                    threshold: 0.1,
                    ...options
                };
                
                this.lazyImages = document.querySelectorAll('.lazy[data-bg]');
                this.loadedCount = 0;
                this.totalDataSaved = 0;
                this.imageObserver = null;
                
                this.init();
                this.updateStats();
            }
            
            init() {
                if ('IntersectionObserver' in window) {
                    this.imageObserver = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                this.loadBackgroundImage(entry.target);
                                this.imageObserver.unobserve(entry.target);
                            }
                        });
                    }, this.options);
                    
                    this.lazyImages.forEach(img => {
                        this.imageObserver.observe(img);
                    });
                } else {
                    // Fallback for older browsers
                    this.lazyImages.forEach(img => {
                        this.loadBackgroundImage(img);
                    });
                }
            }
            
            loadBackgroundImage(element) {
                const bgUrl = element.dataset.bg;
                const placeholder = element.querySelector('.loading-placeholder');
                const errorPlaceholder = element.querySelector('.error-placeholder');
                const estimatedSize = parseInt(element.dataset.size) || 100;
                
                // Create a new image to preload
                const img = new Image();
                
                img.onload = () => {
                    element.style.backgroundImage = `url('${bgUrl}')`;
                    element.classList.remove('lazy');
                    element.classList.add('lazy-loaded');
                    
                    if (placeholder) {
                        placeholder.classList.add('hidden');
                    }
                    
                    this.loadedCount++;
                    this.updateStats();
                    
                    // Trigger custom event
                    element.dispatchEvent(new CustomEvent('lazyloaded', {
                        detail: { src: bgUrl }
                    }));
                };
                
                img.onerror = () => {
                    element.classList.remove('lazy');
                    element.classList.add('lazy-error');
                    
                    if (placeholder) {
                        placeholder.classList.add('hidden');
                    }
                    if (errorPlaceholder) {
                        errorPlaceholder.classList.add('show');
                    }
                    
                    this.totalDataSaved += estimatedSize;
                    this.updateStats();
                    
                    // Trigger custom event
                    element.dispatchEvent(new CustomEvent('lazyerror', {
                        detail: { src: bgUrl }
                    }));
                };
                
                // Start loading
                img.src = bgUrl;
            }
            
            updateStats() {
                const loadedElement = document.getElementById('loaded-count');
                const totalElement = document.getElementById('total-count');
                const savedElement = document.getElementById('data-saved');
                
                if (loadedElement) loadedElement.textContent = this.loadedCount;
                if (totalElement) totalElement.textContent = this.lazyImages.length;
                if (savedElement) {
                    const totalPossibleSaved = Array.from(this.lazyImages)
                        .filter(img => img.classList.contains('lazy'))
                        .reduce((sum, img) => sum + (parseInt(img.dataset.size) || 100), 0);
                    savedElement.textContent = totalPossibleSaved + this.totalDataSaved;
                }
            }
            
            // Public method to manually load all images
            loadAll() {
                this.lazyImages.forEach(img => {
                    if (img.classList.contains('lazy')) {
                        this.loadBackgroundImage(img);
                        if (this.imageObserver) {
                            this.imageObserver.unobserve(img);
                        }
                    }
                });
            }
            
            // Public method to reload failed images
            retryFailed() {
                const failedImages = document.querySelectorAll('.lazy-error[data-bg]');
                failedImages.forEach(img => {
                    img.classList.remove('lazy-error');
                    img.classList.add('lazy');
                    const errorPlaceholder = img.querySelector('.error-placeholder');
                    const loadingPlaceholder = img.querySelector('.loading-placeholder');
                    
                    if (errorPlaceholder) errorPlaceholder.classList.remove('show');
                    if (loadingPlaceholder) loadingPlaceholder.classList.remove('hidden');
                    
                    if (this.imageObserver) {
                        this.imageObserver.observe(img);
                    } else {
                        this.loadBackgroundImage(img);
                    }
                });
            }
        }
        
        // Initialize when DOM is ready
        let lazyLoader;
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                lazyLoader = new LazyBackgroundLoader({
                    rootMargin: '100px 0px',
                    threshold: 0.01
                });
            });
        } else {
            lazyLoader = new LazyBackgroundLoader({
                rootMargin: '100px 0px',
                threshold: 0.01
            });
        }
        
        // Add event listeners for demonstration
        document.addEventListener('lazyloaded', (e) => {
            console.log('Image loaded:', e.detail.src);
        });
        
        document.addEventListener('lazyerror', (e) => {
            console.log('Image failed to load:', e.detail.src);
        });
        
        // Optional: Add intersection debugging
        if (window.location.search.includes('debug=true')) {
            document.addEventListener('lazyloaded', (e) => {
                e.target.style.border = '3px solid green';
                setTimeout(() => {
                    e.target.style.border = 'none';
                }, 2000);
            });
        }
    </script>
</body>
</html>